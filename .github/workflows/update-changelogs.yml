name: Update Changelogs

on:
  # Run daily at 00:00 UTC
  schedule:
    - cron: '0 0 * * *'

  # Allow manual trigger from Actions tab
  workflow_dispatch:
  
  # Run when pushed to master branch
  push:
    branches:
      - master
    paths-ignore:
      - 'changelogs/**'  # Avoid infinite loop when workflow pushes changelog changes

# Permissions for this workflow
permissions:
  contents: write  # Allow reading and writing to repository

jobs:
  update-changelogs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for merging
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm install -g json
          
      - name: Clone PocketMine-MP repository
        run: |
          git clone --depth 1 --branch stable --single-branch https://github.com/pmmp/PocketMine-MP.git /tmp/pmmp
          
      - name: Update changelogs
        run: |
          # Create changelogs directory if it doesn't exist
          mkdir -p changelogs
          
          # Copy changelog files from PocketMine-MP repo
          cp -f /tmp/pmmp/changelogs/*.md changelogs/
          
          # Create a list of all changelog files and sort them in descending order
          cd changelogs
          CHANGELOG_FILES=$(ls -1 *.md | sort -V -r)
          
          # Create JSON array from the file list
          JSON_ARRAY="["
          FIRST=true
          for file in $CHANGELOG_FILES; do
            if [ "$FIRST" = true ]; then
              JSON_ARRAY="$JSON_ARRAY\"$file\""
              FIRST=false
            else
              JSON_ARRAY="$JSON_ARRAY, \"$file\""
            fi
          done
          JSON_ARRAY="$JSON_ARRAY]"
          
          # Create JSON object and save to versions.json
          echo "{\"versions\": $JSON_ARRAY}" | json -o json-4 > versions.json
          
          # Count changelogs
          TOTAL_CHANGELOGS=$(echo "$CHANGELOG_FILES" | wc -l)
          
          # Get newest and oldest versions
          NEWEST_VERSION=$(echo "$CHANGELOG_FILES" | head -n 1 | sed 's/\.md$//')
          OLDEST_VERSION=$(echo "$CHANGELOG_FILES" | tail -n 1 | sed 's/\.md$//')
          
          # Count by type
          STABLE_COUNT=$(echo "$CHANGELOG_FILES" | grep -v -E "(alpha|beta)" | wc -l)
          BETA_COUNT=$(echo "$CHANGELOG_FILES" | grep -E "beta" | wc -l)
          ALPHA_COUNT=$(echo "$CHANGELOG_FILES" | grep -E "alpha" | wc -l)
          
          # Create summary.md
          cat > summary.md << EOF
# PocketMine-MP Changelogs Summary

**Total Changelogs:** ${TOTAL_CHANGELOGS}

## Version Range
- **Newest:** ${NEWEST_VERSION}
- **Oldest:** ${OLDEST_VERSION}

## Version Types
- **Stable:** ${STABLE_COUNT}
- **Beta:** ${BETA_COUNT}
- **Alpha:** ${ALPHA_COUNT}

## All Versions (Newest to Oldest)
$(echo "$CHANGELOG_FILES" | sed 's/\.md$//' | sed 's/^/- /')

_Last updated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")_
EOF
          
          # Report results
          echo "Updated ${TOTAL_CHANGELOGS} changelog files"
          cd ..
          
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git pull --rebase origin master
          git add changelogs/
          if ! git diff --quiet --staged; then
            git commit -m "chore: Update changelogs"
            git push origin master
          fi 